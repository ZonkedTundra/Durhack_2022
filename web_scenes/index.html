<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compiling...</title>
    <style>
        body {
            background-color: black;
            color: white;
            text-align: center;
        }

        .userprofiling {
            border: 3px solid rgb(0, 174, 255);
            height: 40px;
            width: 220px;
            background-color: black;
            color: white;
        }

        p {
            font-size: x-large;
        }

        #balancefooter {
            position: fixed;
            z-index: 100;
            bottom: 0;
            left: 0;
            width: 100%;
        }
    </style>

    <script>
        let App = undefined;
        let scene = 'LoginScene';

        const changeScene = new CustomEvent("change-scene");
        document.addEventListener('change-scene', () => {
            while (App.firstChild)
                App.removeChild(App.firstChild);

            const newScene = document.getElementById(scene).content.cloneNode(true);
            App.appendChild(newScene);

            sceneInits[scene](App);
        });

        const sceneInits = {
            LoginScene: App => {
                function submit() {
                    const token = App.getElementsByClassName("userInput-token")[0].value;
                    if (token === '') {
                        alert('The enter field is blank')
                    } else {
                        SubmitButton.removeEventListener('click', submit);
                        const package = {
                            Type: 'login',
                            Data: {
                                token: token
                            }
                        }
                        ws.send(JSON.stringify(package))
                    }
                }

                const SubmitButton = App.getElementsByClassName('submit')[0];
                SubmitButton.addEventListener('click', submit);
            },
            AIScene: App => {
                function submit() {
                    const alpha = App.getElementsByClassName("userInput-alpha")[0].value;
                    const gamma = App.getElementsByClassName("userInput-gamma")[0].value;
                    const colour = App.getElementsByClassName("userInput-colour")[0].value;
                    const name = App.getElementsByClassName("userInput-name")[0].value;
                    if (alpha === '' || gamma === '' || colour === '' || name === '') {
                        alert('you have have a blank field')
                    } else {
                        if (alpha < 0 || alpha > 1) {
                            alert("your alpha needs to be between 0 and 1")
                        } else if (gamma < 0 || gamma > 1) {
                            alert("your gamma needs to be between 0 and 1")
                        } else {
                            SubmitButton.removeEventListener('click', submit);
                            const package = {
                                Type: 'newAI',
                                Data: {
                                    alpha: alpha,
                                    gamma: gamma,
                                    colour: colour,
                                    name: name
                                }
                            }
                            ws.send(JSON.stringify(package))
                        }
                    }
                }
                const SubmitButton = App.getElementsByClassName('submit')[0];
                SubmitButton.addEventListener('click', submit);
            },

            BettingScene: App => {
                const bet = App.getElementsByClassName("userInput-betting")[0].value;
                const horsename = App.getElementsByClassName("horse-names")[0].value;
                if (bet === '' || horsename === '') {
                    alert('you have have a blank field')
                } else {
                    if (bet > package.Data.balance) {
                        alert("you have insufficient funds")
                    } else {
                        SubmitButton.removeEventListener('click', submit);
                        const package = {
                            Type: 'bettinginfo',
                            Data: {
                                bet: bet,
                                horsename: horsename
                            }
                        }
                        ws.send(JSON.stringify(package))
                        document.dispatchEvent(changeScene);
                        x = document.getElementsByClassName("horse-name")
                        let htmlString = ""
                        for (let i = 0; i < package.Data.horseName; i++) {
                            htmlString += `<option value=${package.Data.horseName[i]}>${package.Data.horseName[i]}</option>`
                        }
                        x.innerHTML = htmlString
                    }
                }
                const SubmitButton = App.getElementsByClassName('submit')[0];
                SubmitButton.addEventListener('click', submit);

            }
        }

        const ws = new WebSocket(`ws://localhost:8080/`);
        ws.onmessage = event => {
            if (event.Data === 'ping')
                return ws.send('pong');

            const package = JSON.parse(event.Data);
            if (package.Type === "loginresponse") {
                // will receive Type, Data(balance(number), success(boolean))
                if (package.Data.success) {
                    scene = "AIScene"
                    document.dispatchEvent(changeScene);
                    x = document.getElementsByClassName("balance-footer")
                    let balanceString = `Balance: ${package.Data.balance}`
                    x.innerHTML = balanceString
                } else {
                    alert("Token is incorrect")
                    scene = "LoginScene"
                    document.dispatchEvent(changeScene);
                }
            }
            if (package.Type === "AIresponse") {
                //will receive Type, Data(balance(number), horsename(list), success(boolean))
                if (package.Data.success) {
                    scene = "BettingScene"
                    document.dispatchEvent(changeScene);
                    x = document.getElementsByClassName("horse-name")
                    let htmlString = ""
                    for (let i = 0; i < package.Data.horseName; i++) {
                        htmlString += `<option value=${package.Data.horseName[i]}>${package.Data.horseName[i]}</option>`
                    }
                    x.innerHTML = htmlString
                    x = document.getElementsByClassName("balance-footer")
                    let balanceString = `Balance: ${package.Data.balance}`
                    x.innerHTML = balanceString
                } else {
                    alert("Data entered is incorrect")
                    scene = "AIScene"
                    document.dispatchEvent(changeScene);
                }
            }
            if (package.Type === "race") {
                //will recieve Type, Data(balance(number))
                scene = "RaceScene"
                document.dispatchEvent(changeScene);
                x = document.getElementsByClassName("balance-footer")
                let balanceString = `Balance: ${package.Data.balance}`
                x.innerHTML = balanceString
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            App = document.getElementById('App');
            document.dispatchEvent(changeScene);
        });

    </script>
</head>

<body>
    <div id="App"></div>
    <footer id="balancefooter">
        <span class="hidden" id="balance-footer">
        </span>
    </footer>
    <template id="LoginScene">
        <form>
            <p>Please enter your token:</p>
            <input Type="text" placeholder="Token" class="userInput-token">
        </form>
        <br>
        <button class="submit">Submit</button>
    </template>

    <template id="AIScene">
        <form>
            <p>Customise your AI:</p>
            <input Type="number" placeholder="Alpha" class="userInput-alpha userprofiling">
            <br>
            <br>
            <input Type="number" placeholder="gamma" class="userInput-gamma userprofiling">
            <br>
            <br>
            <input Type="color" placeholder="AI Colour" class="userInput-colour userprofiling">
            <br>
            <br>
            <input Type="text" placeholder="AI's Name" class="userInput-name userprofiling">
        </form>
        <br>
        <button class="submit">Submit</button>
    </template>
</body>

<template id="BettingScene">
    <p>Choose Your horse:</p>
    <br>
    <select name="horse-names" class="horse-names">
    </select>
    <br>
    <input Type="number" placeholder="Betting amount" class="userInput-betting userprofiling">
    <br>
    <button class="submit">Submit</button>
</template>

<template id="RaceScene">
    <p>Enjoy the race :)</p>
</template>

</html>